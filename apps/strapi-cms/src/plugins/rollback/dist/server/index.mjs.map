{"version":3,"file":"index.mjs","sources":["../../admin/src/pluginId.ts","../../server/src/bootstrap.ts","../../server/src/destroy.ts","../../server/src/register.ts","../../server/src/config/index.ts","../../server/src/content-types/index.ts","../../server/src/controllers/s3.ts","../../server/src/controllers/githubActions.ts","../../server/src/controllers/index.ts","../../server/src/middlewares/index.ts","../../server/src/policies/index.ts","../../server/src/routes/index.ts","../../server/src/services/s3.ts","../../server/src/services/githubActions.ts","../../server/src/services/index.ts","../../server/src/index.ts"],"sourcesContent":["export const PLUGIN_ID = 'rollback';\n","import type { Core } from '@strapi/strapi';\nimport { PLUGIN_ID } from '../../admin/src/pluginId';\n\nconst bootstrap = async ({ strapi }: { strapi: Core.Strapi }) => {\n  // Register permission actions\n  const actions = [\n    {\n      section: 'plugins',\n      subCategory: 'general',\n      displayName: 'Access plugin page',\n      uid: 'access',\n      pluginName: PLUGIN_ID,\n    },\n    {\n      section: 'plugins',\n      subCategory: 'actions',\n      displayName: 'Trigger rollback',\n      uid: 'trigger',\n      pluginName: PLUGIN_ID,\n    },\n  ];\n  await strapi.admin.services.permission.actionProvider.registerMany(actions);\n};\n\nexport default bootstrap;\n","import type { Core } from '@strapi/strapi';\n\nconst destroy = ({ strapi }: { strapi: Core.Strapi }) => {\n  // destroy phase\n};\n\nexport default destroy;\n","import type { Core } from '@strapi/strapi';\n\nconst register = ({ strapi }: { strapi: Core.Strapi }) => {\n  // register phase\n};\n\nexport default register;\n","import Config from '../../../types/config'\n\ntype Validator = Partial<Config>;\n\nexport default {\n  default: {},\n  validator({ githubToken, environment, s3_accessKeyId, s3_secretAccessKey, s3_endpoint, s3_bucketName, s3_region }: Validator) {\n    // Check if required keys are present\n    if (!environment) {\n      throw new Error('`environment` key in your plugin config is required');\n    }\n    if (!githubToken) {\n      throw new Error('`githubToken` key in your plugin config is required');\n    }\n    if (!s3_accessKeyId) {\n      throw new Error('`s3_accessKeyId` key in your plugin config is required');\n    }\n    if (!s3_secretAccessKey) {\n      throw new Error('`s3_secretAccessKey` key in your plugin config is required');\n    }\n    if (!s3_endpoint) {\n      throw new Error('`s3_endpoint` key in your plugin config is required');\n    }\n    if (!s3_bucketName) {\n      throw new Error('`s3_bucketName` key in your plugin config is required');\n    }\n    if (!s3_region) {\n      throw new Error('`s3_region` key in your plugin config is required');\n    }\n    \n    // Check if config is valid\n    if (githubToken && typeof githubToken !== 'string') {\n      throw new Error('`githubToken` key in your plugin config has to be a string');\n    }\n    if (environment && typeof environment !== 'string') {\n      throw new Error('`environment` key in your plugin config has to be a string');\n    }\n    if (s3_accessKeyId && typeof s3_accessKeyId !== 'string') {\n      throw new Error('`s3_accessKeyId` key in your plugin config has to be a string');\n    }\n    if (s3_secretAccessKey && typeof s3_secretAccessKey !== 'string') {\n      throw new Error('`s3_secretAccessKey` key in your plugin config has to be a string');\n    }\n    if (s3_endpoint && typeof s3_endpoint !== 'string') {\n      throw new Error('`s3_endpoint` key in your plugin config has to be a string');\n    }\n    if (s3_bucketName && typeof s3_bucketName !== 'string') {\n      throw new Error('`s3_bucketName` key in your plugin config has to be a string');\n    }\n    if (s3_region && typeof s3_region !== 'string') {\n      throw new Error('`s3_region` key in your plugin config has to be a string');\n    }\n  },\n};\n","export default {};\n","import type { Core } from '@strapi/strapi';\nimport { PLUGIN_ID } from '../../../admin/src/pluginId';\n\nconst s3Controller = ({ strapi }: { strapi: Core.Strapi }) => ({\n  async deployments(ctx: any) {\n    const deploymentsArray = await strapi.plugin(PLUGIN_ID).service('s3').deployments();\n    ctx.send(deploymentsArray);\n  },\n});\n\nexport default s3Controller;\n","import { Core } from '@strapi/strapi';\nimport { PLUGIN_ID } from '../../../admin/src/pluginId';\n\nconst githubActionsController = ({ strapi }: { strapi: Core.Strapi }) => ({\n  async trigger(ctx: any) {\n    const { deployment } = ctx.request.body;\n    const response = await strapi.plugin(PLUGIN_ID).service('githubActions').trigger(deployment);\n    if (response.status === 422 && response.statusText == 'Unprocessable Entity') {\n      return ctx.unprocessableEntity('Unprocessable Entity');\n    }\n    ctx.send(response);\n  },\n});\n\nexport default githubActionsController;\n","import s3 from './s3';\nimport githubActions from './githubActions';\n\nexport default { s3, githubActions };\n","export default {};\n","export default {};\n","export default [\n  {\n    method: 'GET',\n    path: '/deployments',\n    handler: 's3.deployments',\n    config: {\n      policies: ['admin::isAuthenticatedAdmin'],\n    },\n  },\n  {\n    method: 'POST',\n    path: '/trigger',\n    handler: 'githubActions.trigger',\n    config: {\n      policies: ['admin::isAuthenticatedAdmin'],\n    },\n  },\n];\n","import type { Core } from '@strapi/strapi';\nimport { S3Client, ListObjectsV2Command } from '@aws-sdk/client-s3';\nimport { PLUGIN_ID } from '../../../admin/src/pluginId';\n\nconst s3Service = ({ strapi }: { strapi: Core.Strapi }) => ({\n  async deployments() {\n    const environment: string = strapi.plugin(PLUGIN_ID).config('environment');\n    const accessKeyId: string = strapi\n      .plugin(PLUGIN_ID)\n      .config('s3_accessKeyId');\n    const secretAccessKey: string = strapi\n      .plugin(PLUGIN_ID)\n      .config('s3_secretAccessKey');\n    const endpoint: string = strapi.plugin(PLUGIN_ID).config('s3_endpoint');\n    const bucket: string = strapi.plugin(PLUGIN_ID).config('s3_bucketName');\n    const region: string = strapi.plugin(PLUGIN_ID).config('s3_region');\n\n    const s3 = new S3Client({\n      region,\n      endpoint,\n      credentials: {\n        accessKeyId,\n        secretAccessKey,\n      },\n    });\n\n    const command = new ListObjectsV2Command({\n      Bucket: bucket,\n      Prefix: `${environment}/`,\n      Delimiter: '/',\n    });\n\n    const res = await s3.send(command);\n\n    const folders =\n      res.CommonPrefixes?.map((p) =>\n        p.Prefix!.replace(`${environment}/`, '').replace(/\\/$/, ''),\n      ) ?? [];\n\n    return folders.filter((f) => f && f !== 'latest').reverse();\n  },\n});\n\nexport default s3Service;\n","/**\n * @type {typeof fetch}\n */\nconst fetch = globalThis.fetch;\nimport type { Core } from \"@strapi/strapi\";\nimport { PLUGIN_ID } from \"../../../admin/src/pluginId\";\n\nconst githubActionsService = ({ strapi }: { strapi: Core.Strapi }) => ({\n  async trigger(deployment: string) {\n    try {\n      const githubToken = strapi.plugin(PLUGIN_ID).config('githubToken');\n      const environment = strapi.plugin(PLUGIN_ID).config('environment');\n\n      const res = await fetch(\n        'https://api.github.com/repos/pagopa/b2b-portals/actions/workflows/rollback_prod_website.yaml/dispatches',\n        {\n          method: 'POST',\n          headers: {\n            Accept: 'application/vnd.github+json',\n            Authorization: `token ${githubToken}`,\n          },\n          body: JSON.stringify({\n            ref: 'main',\n            inputs: {\n              environment,\n              timestamp: deployment,\n            },\n          }),\n        },\n      );\n\n      return {\n        success: res.ok,\n        status: res.status,\n      }\n    } catch (err: any) {\n      return {\n        success: false,\n        err,\n      }\n    }\n  },\n});\n\nexport default githubActionsService;\n","import s3 from './s3';\nimport githubActions from './githubActions';\n\nexport default { s3, githubActions };\n","/**\n * Application methods\n */\nimport bootstrap from './bootstrap';\nimport destroy from './destroy';\nimport register from './register';\n\n/**\n * Plugin server methods\n */\nimport config from './config';\nimport contentTypes from './content-types';\nimport controllers from './controllers';\nimport middlewares from './middlewares';\nimport policies from './policies';\nimport routes from './routes';\nimport services from './services';\n\nexport default {\n  register,\n  bootstrap,\n  destroy,\n  config,\n  controllers,\n  routes,\n  services,\n  contentTypes,\n  policies,\n  middlewares,\n};\n"],"names":["s3","githubActions"],"mappings":"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"}